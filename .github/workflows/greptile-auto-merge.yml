# .github/workflows/greptile-auto-merge.yml
#
# Auto-merge PRs that receive a Greptile confidence score of 4/5 or higher.
# Requires: GITHUB_TOKEN with write permissions (default) or a PAT for protected branches.
#
# Setup:
# 1. Copy this file to .github/workflows/greptile-auto-merge.yml in your repo
# 2. Enable "Allow auto-merge" in repo settings (Settings ‚Üí General ‚Üí Pull Requests)
# 3. Optionally set branch protection rules requiring Greptile status check
#
name: Greptile Auto-Merge

on:
  pull_request_review:
    types: [submitted]
  # Also trigger on check runs for Greptile status check
  check_run:
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # Only run if the review/check is from Greptile
    if: |
      (github.event_name == 'pull_request_review' && contains(github.event.review.user.login, 'greptile')) ||
      (github.event_name == 'check_run' && contains(github.event.check_run.name, 'Greptile'))
    
    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber;
            
            if (context.eventName === 'pull_request_review') {
              prNumber = context.payload.pull_request.number;
            } else if (context.eventName === 'check_run') {
              // Get PR from check run
              const checkRun = context.payload.check_run;
              if (checkRun.pull_requests && checkRun.pull_requests.length > 0) {
                prNumber = checkRun.pull_requests[0].number;
              }
            }
            
            if (!prNumber) {
              console.log('No PR found');
              return;
            }
            
            core.setOutput('pr_number', prNumber);
            
            // Get all reviews on the PR
            const reviews = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            // Find Greptile's review
            const greptileReview = reviews.data.find(r => 
              r.user.login.toLowerCase().includes('greptile')
            );
            
            if (!greptileReview) {
              console.log('No Greptile review found yet');
              core.setOutput('should_merge', 'false');
              return;
            }
            
            // Parse confidence score from review body
            // Looks for patterns like "Confidence Score: 4/5" or "confidence: 5/5"
            const scoreMatch = greptileReview.body.match(/confidence[:\s]*(\d)\/5/i);
            
            if (!scoreMatch) {
              console.log('No confidence score found in review');
              core.setOutput('should_merge', 'false');
              return;
            }
            
            const score = parseInt(scoreMatch[1]);
            console.log(`Greptile confidence score: ${score}/5`);
            
            core.setOutput('confidence_score', score);
            core.setOutput('should_merge', score >= 4 ? 'true' : 'false');

      - name: Auto-approve PR
        if: steps.pr.outputs.should_merge == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.pr_number }};
            const score = ${{ steps.pr.outputs.confidence_score }};
            
            // Approve the PR
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              event: 'APPROVE',
              body: `ü§ñ Auto-approved based on Greptile confidence score: **${score}/5**\n\nThis PR meets the auto-merge threshold (‚â•4/5).`
            });
            
            console.log(`PR #${prNumber} approved with score ${score}/5`);

      - name: Enable auto-merge
        if: steps.pr.outputs.should_merge == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.pr_number }};
            
            try {
              // Enable auto-merge (squash)
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                auto_merge: {
                  merge_method: 'squash'
                }
              });
              console.log(`Auto-merge enabled for PR #${prNumber}`);
            } catch (error) {
              // If auto-merge isn't enabled in repo settings, try direct merge
              console.log('Auto-merge not available, attempting direct merge...');
              
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash',
                commit_title: `Auto-merge PR #${prNumber} (Greptile score: ${{ steps.pr.outputs.confidence_score }}/5)`
              });
              console.log(`PR #${prNumber} merged directly`);
            }

      - name: Comment on low-score PRs
        if: steps.pr.outputs.should_merge == 'false' && steps.pr.outputs.confidence_score != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.pr_number }};
            const score = ${{ steps.pr.outputs.confidence_score }};
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `‚ö†Ô∏è **Manual review required**\n\nGreptile confidence score: **${score}/5**\n\nThis PR scored below the auto-merge threshold (4/5). Please address Greptile's feedback and request a re-review, or get manual approval from a team member.`
            });
